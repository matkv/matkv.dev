{{ define "main" }}
<main class="full-width">
    <h1>{{ .Title }}</h1>
    {{ .Content }}

    {{/* Build two collections: finished and to-read */}}
    {{ $.Scratch.Set "finished" (slice) }}
    {{ $.Scratch.Set "toread" (slice) }}
    {{ range .Pages }}
    {{ if in .Params.status "Finished" }}
    {{ $.Scratch.Add "finished" . }}
    {{ else }}
    {{ $.Scratch.Add "toread" . }}
    {{ end }}
    {{ end }}

    <section class="book-grids">
        {{ $finished := $.Scratch.Get "finished" }}
        {{ if gt (len $finished) 0 }}
        <h2>Finished</h2>
        <div class="book-grid">
            {{ range $finished }}
            <article class="book-card">
                <a href="{{ .RelPermalink }}" class="book-link">
                    <div class="cover-wrap">
                        {{ $jpg := printf "/covers/%s.jpg" .Params.isbn | relURL }}
                        {{ $png := printf "/covers/%s.png" .Params.isbn | relURL }}
                        {{ $pngFile := printf "static/covers/%s.png" .Params.isbn }}
                        {{ $jpgFile := printf "static/covers/%s.jpg" .Params.isbn }}
                        {{ $pngExists := fileExists $pngFile }}
                        {{ $jpgExists := fileExists $jpgFile }}
                        {{ if $pngExists }}
                        <img src="{{ $png | relURL }}" alt="{{ .Title }} cover" data-jpg="{{ $jpg }}"
                            data-png="{{ $png }}">
                        {{ else if $jpgExists }}
                        <img src="{{ $jpg }}" alt="{{ .Title }} cover" data-jpg="{{ $jpg }}" data-png="{{ $png }}">
                        {{ else }}
                        <img src="/style.css" alt="{{ .Title }} cover missing">
                        {{ end }}
                    </div>
                    <div class="book-meta">
                        <h3 class="book-title">{{ .Title }}</h3>
                        <div class="book-author">{{ delimit .Params.author ", " }}</div>
                        {{ with .Params.rating }}<div class="book-rating">Rating: {{ . }}</div>{{ end }}
                    </div>
                </a>
                {{ with .Content }}
                <details class="book-review">
                    <summary>Review</summary>
                    {{ . | markdownify }}
                </details>
                {{ end }}
            </article>
            {{ end }}
        </div>
        {{ end }}

        {{ $toread := $.Scratch.Get "toread" }}
        {{ if gt (len $toread) 0 }}
        <h2>To read</h2>
        <div class="book-grid">
            {{ range $toread }}
            <article class="book-card">
                <a href="{{ .RelPermalink }}" class="book-link">
                    <div class="cover-wrap">
                        {{ $jpg := printf "/covers/%s.jpg" .Params.isbn | relURL }}
                        {{ $png := printf "/covers/%s.png" .Params.isbn | relURL }}
                        {{ $pngFile := printf "static/covers/%s.png" .Params.isbn }}
                        {{ $jpgFile := printf "static/covers/%s.jpg" .Params.isbn }}
                        {{ $pngExists := fileExists $pngFile }}
                        {{ $jpgExists := fileExists $jpgFile }}
                        {{ if $pngExists }}
                        <img src="{{ $png | relURL }}" alt="{{ .Title }} cover" data-jpg="{{ $jpg }}"
                            data-png="{{ $png }}">
                        {{ else if $jpgExists }}
                        <img src="{{ $jpg }}" alt="{{ .Title }} cover" data-jpg="{{ $jpg }}" data-png="{{ $png }}">
                        {{ else }}
                        <img src="/style.css" alt="{{ .Title }} cover missing">
                        {{ end }}
                    </div>
                    <div class="book-meta">
                        <h3 class="book-title">{{ .Title }}</h3>
                        <div class="book-author">{{ delimit .Params.author ", " }}</div>
                    </div>
                </a>
                {{ with .Content }}
                <details class="book-review">
                    <summary>Notes</summary>
                    {{ . | markdownify }}
                </details>
                {{ end }}
            </article>
            {{ end }}
        </div>
        {{ end }}
    </section>

</main>
{{ end }}